<config xmlns="http://tail-f.com/ns/config/1.0">
  <profiles xmlns="https://curity.se/ns/conf/base">
    <profile>
      <id>admin</id>
      <type xmlns:as="https://curity.se/ns/conf/profile/oauth">as:oauth-service</type>
      <expose-detailed-error-messages/>
      <settings>
        <authorization-server xmlns="https://curity.se/ns/conf/profile/oauth">
          <client-capabilities>
            <client-credentials/>
          </client-capabilities>
          <client-store>
            <config-backed>
              <client>
                <id>admin</id>
                <secret>$5$3lHJGUGTbnZNTTMW$wpTPUfHnjVka7jIcPf2u79aSDSQniAieYBOg8fGSq8B</secret>
                <access-token-ttl>3000</access-token-ttl>
                <capabilities>
                  <client-credentials/>
                </capabilities>
              </client>
            </config-backed>
          </client-store>
        </authorization-server>
      </settings>
      <endpoints>
        <endpoint>
          <id>admin-anonymous</id>
          <uri>/admin/oauth-anonymous</uri>
          <endpoint-kind>oauth-anonymous</endpoint-kind>
        </endpoint>
        <endpoint>
          <id>admin-token</id>
          <uri>/admin/token</uri>
          <endpoint-kind>oauth-token</endpoint-kind>
        </endpoint>
      </endpoints>
      <token-issuers>
        <default-token-issuer>
          <jwt-issuer-settings>
            <signing-key-id>default-signing-key</signing-key-id>
          </jwt-issuer-settings>
          <default-data-source>DefaultDataSource</default-data-source>
        </default-token-issuer>
      </token-issuers>
    </profile>
    <profile>
      <id>authentication</id>
      <type xmlns:auth="https://curity.se/ns/conf/profile/authentication">auth:authentication-service</type>
      <expose-detailed-error-messages/>
      <settings>
        <authentication-service xmlns="https://curity.se/ns/conf/profile/authentication">
          <redirect-url-whitelist>
            <url>http://localhost:5000*</url>
          </redirect-url-whitelist>
          <authenticators>
            <authenticator>
              <id>janedoe</id>
              <test xmlns="https://curity.se/ns/ext-conf/test">
                <username>janedoe</username>
              </test>
            </authenticator>
            <authenticator>
              <id>larseriksson</id>
              <test xmlns="https://curity.se/ns/ext-conf/test">
                <username>larseriksson</username>
              </test>
            </authenticator>
          </authenticators>
          <protocols>
            <protocol>
              <id>simple1</id>
              <simple-api>
                <signing-key>default-signing-key</signing-key>
                <signature-algorithm>RS256</signature-algorithm>
              </simple-api>
            </protocol>
          </protocols>
        </authentication-service>
      </settings>
      <endpoints>
        <endpoint>
          <id>authentication</id>
          <uri>/authentication</uri>
          <endpoint-kind>auth-authentication</endpoint-kind>
        </endpoint>
      </endpoints>
      <token-issuers>
        <default-token-issuer>
          <jwt-issuer-settings>
            <signing-key-id>default-signing-key</signing-key-id>
          </jwt-issuer-settings>
          <default-data-source>DefaultDataSource</default-data-source>
        </default-token-issuer>
      </token-issuers>
    </profile>
    <profile>
      <id>oauth</id>
      <type xmlns:as="https://curity.se/ns/conf/profile/oauth">as:oauth-service</type>
      <expose-detailed-error-messages/>
      <settings>
        <authorization-server xmlns="https://curity.se/ns/conf/profile/oauth">
          <reuse-refresh-tokens>true</reuse-refresh-tokens>
          <authentication-service>
            <authentication-profile>authentication</authentication-profile>
          </authentication-service>
          <client-capabilities>
            <code>
            </code>
            <introspection/>
          </client-capabilities>
          <scopes>
            <scope>
              <id>admin</id>
              <description>A scope that is only available to back-end services</description>
            </scope>
            <scope>
              <id>openid</id>
              <description>Standard OpenID Connect scope</description>
            </scope>
          </scopes>
          <openid-connect>
            <id-token-ttl>3600</id-token-ttl>
          </openid-connect>
          <client-store>
            <config-backed>
              <client>
                <id>gateway_client</id>
                <description>An API gateway or reverse proxy client that can convert phantom tokens to internal JWT tokens</description>
                <secret>$5$k5Y/ZHQ7KvYULt6W$UE1dkXED11KC9LyM8ZI95YasFElYlNuciMCrLMJ4jO6</secret>
                <capabilities>
                  <introspection/>
                </capabilities>
              </client>
              <client>
                <id>www</id>
                <secret>$5$TVyfCyGXcV1F.bwI$iQGIpHMlxsNM3LkgNbareIKW19iQLRa.iTue/JFBFL.</secret>
                <redirect-uris>http://localhost:5000/cb</redirect-uris>
                <scope>openid</scope>
                <user-authentication>
                </user-authentication>
                <capabilities>
                  <code/>
                </capabilities>
              </client>
              <client>
                <id>www2</id>
                <secret>$5$vrMM1UGyCRyh9IpE$j.dFhT/22BXFsoPbPoqFJ1rAqZD9d2sFcKP4Yo9f5e0</secret>
                <redirect-uris>http://localhost:5000/cb</redirect-uris>
                <scope>openid</scope>
                <user-authentication>
                </user-authentication>
                <capabilities>
                  <code/>
                </capabilities>
              </client>
            </config-backed>
          </client-store>
        </authorization-server>
      </settings>
      <endpoints>
        <endpoint>
          <id>authorize</id>
          <uri>/authorize</uri>
          <endpoint-kind>oauth-authorize</endpoint-kind>
        </endpoint>
        <endpoint>
          <id>introspection</id>
          <uri>/introspection</uri>
          <endpoint-kind>oauth-introspect</endpoint-kind>
          <introspect-endpoint-procedures>
            <flow>oauth-introspect-application-jwt</flow>
            <procedure>intro</procedure>
          </introspect-endpoint-procedures>
        </endpoint>
        <endpoint>
          <id>oauth-anonymous</id>
          <uri>/~</uri>
          <endpoint-kind>oauth-anonymous</endpoint-kind>
        </endpoint>
        <endpoint>
          <id>token</id>
          <uri>/token</uri>
          <endpoint-kind>oauth-token</endpoint-kind>
          <token-endpoint-procedures>
            <flow>oauth-token-authorization-code</flow>
            <procedure>authorize</procedure>
          </token-endpoint-procedures>
        </endpoint>
      </endpoints>
      <token-issuers>
        <default-token-issuer>
          <jwt-issuer-settings>
            <signing-key-id>default-signing-key</signing-key-id>
          </jwt-issuer-settings>
          <default-data-source>DefaultDataSource</default-data-source>
        </default-token-issuer>
      </token-issuers>
    </profile>
    <profile>
      <id>um1</id>
      <type xmlns:um="https://curity.se/ns/conf/profile/user-management">um:user-management-service</type>
      <expose-detailed-error-messages/>
      <settings>
        <user-management-service xmlns="https://curity.se/ns/conf/profile/user-management">
          <api-authentication>
            <oauth-service>admin</oauth-service>
          </api-authentication>
          <user-account-data-source>DefaultDataSource</user-account-data-source>
          <token-data-source>DefaultDataSource</token-data-source>
        </user-management-service>
      </settings>
      <endpoints>
        <endpoint>
          <id>um1-admin</id>
          <uri>/um/admin</uri>
          <endpoint-kind>um-api</endpoint-kind>
        </endpoint>
      </endpoints>
    </profile>
  </profiles>
  <processing xmlns="https://curity.se/ns/conf/base">
    <procedures>
      <token-procedure>
        <id>authorize</id>
        <flow>oauth-token-authorization-code</flow>
        <script>ZnVuY3Rpb24gcmVzdWx0KGNvbnRleHQpIHsKICAgIHZhciBkZWxlZ2F0aW9uRGF0YSA9IGNvbnRleHQuZ2V0RGVmYXVsdERlbGVnYXRpb25EYXRhKCk7CiAgICB2YXIgdXNlckFnZW50SWQgPSBkZWxlZ2F0aW9uRGF0YVsidXNlcl9hZ2VudF9pZCJdID0gY29udGV4dC5yZXF1ZXN0LmdldFBhcmFtZXRlcigidXNlcl9hZ2VudF9pZCIpOwogICAgdmFyIGlzc3VlZERlbGVnYXRpb24gPSBjb250ZXh0LmRlbGVnYXRpb25Jc3N1ZXIuaXNzdWUoZGVsZWdhdGlvbkRhdGEpOwoKICAgIHZhciBhY2Nlc3NUb2tlbkRhdGEgPSBjb250ZXh0LmdldERlZmF1bHRBY2Nlc3NUb2tlbkRhdGEoKTsKICAgIHZhciBpc3N1ZWRBY2Nlc3NUb2tlbiA9IGNvbnRleHQuYWNjZXNzVG9rZW5Jc3N1ZXIuaXNzdWUoYWNjZXNzVG9rZW5EYXRhLCBpc3N1ZWREZWxlZ2F0aW9uKTsKCiAgICB2YXIgcmVmcmVzaFRva2VuRGF0YSA9IGNvbnRleHQuZ2V0RGVmYXVsdFJlZnJlc2hUb2tlbkRhdGEoKTsKICAgIHZhciBpc3N1ZWRSZWZyZXNoVG9rZW4gPSBjb250ZXh0LnJlZnJlc2hUb2tlbklzc3Vlci5pc3N1ZShyZWZyZXNoVG9rZW5EYXRhLCBpc3N1ZWREZWxlZ2F0aW9uKTsKCiAgICB2YXIgcmVzcG9uc2VEYXRhID0gewogICAgICAgIGFjY2Vzc190b2tlbjogaXNzdWVkQWNjZXNzVG9rZW4sCiAgICAgICAgc2NvcGUgOiBhY2Nlc3NUb2tlbkRhdGEuc2NvcGUsCiAgICAgICAgcmVmcmVzaF90b2tlbjogaXNzdWVkUmVmcmVzaFRva2VuLAogICAgICAgIHRva2VuX3R5cGU6ICdiZWFyZXInLAogICAgICAgIHN1YjogYWNjZXNzVG9rZW5EYXRhLnN1YiwKICAgICAgICBkZWxlZ2F0aW9uX2lkOiBpc3N1ZWREZWxlZ2F0aW9uLmlkLAogICAgICAgIHVzZXJfYWdlbnRfaWQ6IHVzZXJBZ2VudElkLAogICAgICAgIGV4cGlyZXNfaW46IHNlY29uZHNVbnRpbChhY2Nlc3NUb2tlbkRhdGEuZXhwKQogICAgfTsKCiAgICBpZiAoY29udGV4dC5zY29wZU5hbWVzLmNvbnRhaW5zKCdvcGVuaWQnKSkgewogICAgICAgIHZhciBpZFRva2VuRGF0YSA9IGNvbnRleHQuZ2V0RGVmYXVsdElkVG9rZW5EYXRhKCk7CgogICAgICAgIHZhciBpZFRva2VuSXNzdWVyID0gY29udGV4dC5pZFRva2VuSXNzdWVyOwogICAgICAgIGlkVG9rZW5EYXRhLmF0X2hhc2ggPSBpZFRva2VuSXNzdWVyLmF0SGFzaChpc3N1ZWRBY2Nlc3NUb2tlbik7CgogICAgICAgIHJlc3BvbnNlRGF0YS5pZF90b2tlbiA9IGlkVG9rZW5Jc3N1ZXIuaXNzdWUoaWRUb2tlbkRhdGEsIGlzc3VlZERlbGVnYXRpb24pOwogICAgfQoKICAgIHJldHVybiByZXNwb25zZURhdGE7Cn0=</script>
      </token-procedure>
      <token-procedure>
        <id>intro</id>
        <flow>oauth-introspect-application-jwt</flow>
        <script>ZnVuY3Rpb24gcmVzdWx0KGNvbnRleHQpIHsKICAgIHZhciByZXNwb25zZURhdGEgPSB7fTsKICAgIHZhciBkZWZhdWx0QXRKd3RJc3N1ZXIgPSBjb250ZXh0LmdldERlZmF1bHRBY2Nlc3NUb2tlbkp3dElzc3VlcigpOwoKICAgIGlmIChkZWZhdWx0QXRKd3RJc3N1ZXIgJiYgY29udGV4dC5wcmVzZW50ZWRUb2tlbi5hY3RpdmUgJiYgY29udGV4dC5kZWxlZ2F0aW9uKSB7CiAgICAgICAgCiAgICAgICAgbG9nZ2VyLndhcm4oIkRlbGVnYXRpb24gc3RhdHVzID0gIiArIGNvbnRleHQuZGVsZWdhdGlvbi5kYXRhLnN0YXR1cyk7CiAgICAgICAgCiAgICAgICAgcmVzcG9uc2VEYXRhLmp3dCA9IGRlZmF1bHRBdEp3dElzc3Vlci5pc3N1ZShjb250ZXh0LnByZXNlbnRlZFRva2VuLmRhdGEsIGNvbnRleHQuZGVsZWdhdGlvbik7CiAgICAgICAgcmVzcG9uc2VEYXRhLmFjdGl2ZSA9IHRydWU7CiAgICB9CgogICAgcmV0dXJuIHJlc3BvbnNlRGF0YTsKfQ==</script>
      </token-procedure>
    </procedures>
  </processing>
</config>